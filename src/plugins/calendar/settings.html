<div>
  <label class="form-label">Calendars:</label>
  <div id="calendarList"></div>
  <button type="button" id="addCalendarBtn" class="form-input collapsible" onclick="addCalendarInput('', '#007BFF')">Add Calendar</button>
</div>

<div class="form-group">
    <div class="form-group">
        <label class="form-label">Layout: </label>
        <div class="button-group" id="viewSelector">
            <button type="button" data-value="timeGridDay" onclick="selectView(this)">Day</button>
            <button type="button" data-value="timeGridWeek" onclick="selectView(this)">Week</button>
            <button type="button" data-value="dayGrid" onclick="selectView(this)">Multi-Week</button>
            <button type="button" data-value="dayGridMonth" onclick="selectView(this)">Month</button>
            <button type="button" data-value="listMonth" onclick="selectView(this)">List</button>
        </div>
    </div>
    <input type="hidden" name="viewMode" id="viewMode" value="timeGridDay">
    <div class="form-group">
        <label for="language" class="form-label">Language:</label>
        <select id="language" name="language" class="form-input">
            {% for code, name in locale_map.items() %}
                <option value="{{ code }}">{{ name }}</option>
            {% endfor %}
        </select>
    </div>
</div>

<div class="form-group">
    <label for="displayTitle" class="form-label">Display: </label>

    <div class="form-group">
      <input type="checkbox" id="displayTitle" name="displayTitle" value="true" checked onclick="this.value=this.checked ? 'true' : 'false';">
      <span>Title</span>
    </div>

    <div class="form-group">
        <input type="checkbox" id="displayWeekends" name="displayWeekends" value="true" checked onclick="this.value=this.checked ? 'true' : 'false';">
        <span>Weekends</span>
    </div>

    <div class="form-group">
      <input type="checkbox" id="displayEventTime" name="displayEventTime" value="true" checked onclick="this.value=this.checked ? 'true' : 'false';">
      <span>Event Time</span>
    </div>

    <div class="form-group" data-visible-modes="timeGridDay,timeGridWeek">
      <input type="checkbox" id="displayNowIndicator" name="displayNowIndicator" value="true" checked onclick="this.value=this.checked ? 'true' : 'false';">
      <span>Now Indicator</span>
      <input type="color" id="nowIndicatorColor" name="nowIndicatorColor" class="color-picker" value="#ff0000">
    </div>

    <div class="form-group" data-visible-modes="timeGridWeek">
      <input type="checkbox" id="displayPreviousDays" name="displayPreviousDays" value="true" checked onclick="this.value=this.checked ? 'true' : 'false';">
      <span>Previous Days</span>
    </div>
</div>

<div class="form-group">
    <div class="form-group nowrap" data-visible-modes="timeGridWeek,dayGridMonth,dayGrid">
        <label for="weekStartDay" class="form-label">Week Start Day:</label>
        <select id="weekStartDay" name="weekStartDay" class="form-input">
            <option value="0">Sunday</option>
            <option value="1">Monday</option>
            <option value="2">Tuesday</option>
            <option value="3">Wednesday</option>
            <option value="4">Thursday</option>
            <option value="5">Friday</option>
            <option value="6">Saturday</option>
        </select>
    </div>

    <div class="form-group nowrap" data-visible-modes="timeGridDay,timeGridWeek">
        <label for="interval">Time Interval:</label>
        <input type="number" id="startTimeInterval" name="startTimeInterval" class="form-input" min="0" max="24" placeholder="00">
        -
        <input type="number" id="endTimeInterval" name="endTimeInterval" class="form-input" min="0" max="24" placeholder="24">
    </div>

    <div class="form-group nowrap" data-visible-modes="dayGrid">
        <label for="interval">Display Weeks:</label>
        <input type="number" id="displayWeeks" name="displayWeeks" class="form-input" min="1" max="52" placeholder="4">
    </div>

    <div class="form-group nowrap">
        <label for="fontSize" class="form-label">Font Size:</label>
        <select id="fontSize" name="fontSize" class="form-input">
            <option value="x-small">Extra Small</option>
            <option value="smaller">Smaller</option>
            <option value="small">Small</option>
            <option value="normal">Normal</option>
            <option value="large">Large</option>
            <option value="larger">Larger</option>
            <option value="x-large">Extra Larger</option>
        </select>
    </div>
</div>

<script>
    // Simple client-side persistence for calendar settings
    // Stores and restores settings in localStorage so your selections survive page reloads
    const STORAGE_KEY = (() => {
        try {
            // pluginInstanceName is defined globally in plugin.html
            const inst = (typeof pluginInstanceName !== 'undefined' && pluginInstanceName) ? pluginInstanceName : 'default';
            return `inkyPi.calendar.settings.${inst}`;
        } catch (_) {
            return 'inkyPi.calendar.settings.default';
        }
    })();

    function loadLocalSettings() {
        try {
            const raw = localStorage.getItem(STORAGE_KEY);
            return raw ? JSON.parse(raw) : null;
        } catch (e) {
            console.warn('Failed to read local calendar settings:', e);
            return null;
        }
    }

    function collectSettingsFromForm() {
        const getBool = (id) => document.getElementById(id)?.checked ?? false;
        const getVal = (id) => document.getElementById(id)?.value ?? '';

        // Gather dynamic calendar entries
        const urls = Array.from(document.querySelectorAll('input[name="calendarURLs[]"]')).map(i => i.value);
        const colors = Array.from(document.querySelectorAll('input[name="calendarColors[]"]')).map(i => i.value || '#007BFF');

        return {
            viewMode: getVal('viewMode'),
            language: getVal('language'),
            fontSize: getVal('fontSize'),

            displayTitle: getBool('displayTitle'),
            displayWeekends: getBool('displayWeekends'),
            displayEventTime: getBool('displayEventTime'),
            displayNowIndicator: getBool('displayNowIndicator'),
            nowIndicatorColor: getVal('nowIndicatorColor') || '#ff0000',
            displayPreviousDays: getBool('displayPreviousDays'),

            weekStartDay: getVal('weekStartDay'),
            startTimeInterval: getVal('startTimeInterval'),
            endTimeInterval: getVal('endTimeInterval'),
            displayWeeks: getVal('displayWeeks'),

            "calendarURLs[]": urls,
            "calendarColors[]": colors,
        };
    }

    function saveLocalSettings() {
        try {
            const data = collectSettingsFromForm();
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        } catch (e) {
            console.warn('Failed to save local calendar settings:', e);
        }
    }

    function selectView(button) {
      // Remove 'active' from all buttons
      const buttons = document.querySelectorAll('#viewSelector button');
      buttons.forEach(btn => btn.classList.remove('active'));

      // Add 'active' to the clicked button
      button.classList.add('active');

      // Set hidden input value from button's data-value
      const value = button.getAttribute('data-value');
      document.getElementById('viewMode').value = value;

      updateViewDependentOptions(value);
    }

    function updateViewDependentOptions(viewMode) {
        const conditionals = document.querySelectorAll('[data-visible-modes]');

        conditionals.forEach(el => {
            const allowedViews = el.getAttribute('data-visible-modes').split(',');
            const shouldShow = allowedViews.includes(viewMode);

            el.style.display = shouldShow ? '' : 'none';

            // Enable or disable all inputs inside the element
            const inputs = el.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                input.disabled = !shouldShow;
            });
        });
    }

    function addCalendarInput(url = '', color = '#007BFF') {
        const calendarList = document.getElementById('calendarList');

        const wrapper = document.createElement('div');
        wrapper.classList.add('calendar-entry');
        wrapper.classList.add('form-group');

        const colorInput = document.createElement('input');
        colorInput.type = 'color';
        colorInput.name = 'calendarColors[]';
        colorInput.classList.add('color-picker')
        colorInput.value = color;

        const urlInput = document.createElement('input');
        urlInput.type = 'text';
        urlInput.name = 'calendarURLs[]';
        urlInput.placeholder = 'Calendar URL';
        urlInput.required = true;
        urlInput.classList.add('form-input');
        urlInput.value = url;

        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.innerText = 'âœ•';
        removeBtn.classList.add('remove-btn');
        removeBtn.onclick = () => wrapper.remove();

        wrapper.appendChild(colorInput);
        wrapper.appendChild(urlInput);
        wrapper.appendChild(removeBtn);

        calendarList.appendChild(wrapper);
    }

    // populate form values from plugin settings and localStorage
    document.addEventListener('DOMContentLoaded', () => {
        const viewModeInput = document.getElementById('viewMode');
        const viewButtons = document.querySelectorAll('#viewSelector button');

        // defaults
        let settings = {
            viewMode: 'dayGridMonth',
            language: 'en',
            fontSize: 'normal',
            displayTitle: true,
            displayWeekends: true,
            displayEventTime: true,
            displayNowIndicator: true,
            nowIndicatorColor: '#ff0000',
            displayPreviousDays: true,
            weekStartDay: '0',
            startTimeInterval: '',
            endTimeInterval: '',
            displayWeeks: '',
            "calendarURLs[]": [''],
            "calendarColors[]": ['#007BFF'],
        };

        // Merge server-provided pluginSettings if available
        if (typeof loadPluginSettings !== 'undefined' && loadPluginSettings && typeof pluginSettings !== 'undefined') {
            settings = { ...settings, ...pluginSettings };
            // Normalize calendars from pluginSettings shape into arrays if present
            if (pluginSettings["calendarURLs[]"]) {
                settings["calendarURLs[]"] = pluginSettings["calendarURLs[]"];
                settings["calendarColors[]"] = pluginSettings["calendarColors[]"] || [];
            }
        }

        // Finally, apply any locally saved (unsaved) edits on top
        const local = loadLocalSettings();
        if (local) {
            settings = { ...settings, ...local };
        }

        // populate view mode buttons and hidden field
        const viewMode = settings.viewMode || 'dayGridMonth';
        viewModeInput.value = viewMode;
        viewButtons.forEach(btn => {
            if (btn.getAttribute('data-value') === viewMode) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        });

        // simple value setters
        const setChecked = (id, val) => {
            const el = document.getElementById(id);
            if (!el) return;
            el.checked = Boolean(val);
            el.value = el.checked ? 'true' : 'false';
        };
        const setValue = (id, val) => { const el = document.getElementById(id); if (el) el.value = val ?? ''; };

        setValue('language', settings.language);
        setValue('fontSize', settings.fontSize);

        setChecked('displayTitle', settings.displayTitle);
        setChecked('displayWeekends', settings.displayWeekends);
        setChecked('displayEventTime', settings.displayEventTime);
        setChecked('displayNowIndicator', settings.displayNowIndicator);
        setValue('nowIndicatorColor', settings.nowIndicatorColor || '#ff0000');
        setChecked('displayPreviousDays', settings.displayPreviousDays);

        setValue('weekStartDay', settings.weekStartDay);
        setValue('startTimeInterval', settings.startTimeInterval);
        setValue('endTimeInterval', settings.endTimeInterval);
        setValue('displayWeeks', settings.displayWeeks);

        // populate calendars (clear current list first)
        const calendarList = document.getElementById('calendarList');
        if (calendarList) calendarList.innerHTML = '';
        const urls = settings["calendarURLs[]"] || [];
        const colors = settings["calendarColors[]"] || [];
        const count = Math.max(urls.length, colors.length, 0);
        if (count === 0) {
            addCalendarInput('', '#007BFF');
        } else {
            for (let i = 0; i < count; i++) {
                addCalendarInput(urls[i] || '', colors[i] || '#007BFF');
            }
        }

        updateViewDependentOptions(viewMode);

        // Auto-save on changes
        const wireAutoSave = () => {
            const all = document.querySelectorAll('input, select, textarea');
            all.forEach(el => {
                el.addEventListener('change', saveLocalSettings);
                if (el.tagName === 'INPUT' && (el.type === 'text' || el.type === 'number' || el.type === 'color')) {
                    el.addEventListener('input', saveLocalSettings);
                }
            });
        };
        wireAutoSave();

        // Ensure dynamically added/removed calendar rows also trigger save
        const addButton = document.getElementById('addCalendarBtn');
        if (addButton) {
            addButton.addEventListener('click', () => {
                // allow existing onclick to add the inputs, then attach listeners and save
                setTimeout(() => { wireAutoSave(); saveLocalSettings(); }, 0);
            });
        }

        // Observe calendar list for removals and save
        if (calendarList) {
            const obs = new MutationObserver(() => {
                saveLocalSettings();
            });
            obs.observe(calendarList, { childList: true, subtree: true });
        }

        // When settings are saved to the server, clear local cache so server values take precedence next load
        window.addEventListener('plugin-settings-saved', () => {
            try { localStorage.removeItem(STORAGE_KEY); } catch (_) {}
        });
    });
</script>
